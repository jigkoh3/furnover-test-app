"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.routeConfiguringFunction = routeConfiguringFunction;
exports.isSessionCommand = isSessionCommand;
exports.driverShouldDoJwpProxy = driverShouldDoJwpProxy;
exports.IMAGE_ELEMENT_PREFIX = exports.W3C_ELEMENT_KEY = exports.MJSONWP_ELEMENT_KEY = exports.Protocol = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _validators = require("./validators");

var _errors = require("./errors");

var _routes = require("./routes");

var _helpers = require("../basedriver/helpers");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _driver = _interopRequireDefault(require("../basedriver/driver"));

var _lruCache = _interopRequireDefault(require("lru-cache"));

const GENERIC_PROTOCOL = 'GENERIC';

const mjsonwpLog = _appiumSupport.logger.getLogger('MJSONWP');

const w3cLog = _appiumSupport.logger.getLogger('W3C');

const genericProtocolLog = _appiumSupport.logger.getLogger(GENERIC_PROTOCOL);

const JSONWP_SUCCESS_STATUS_CODE = 0;
const LOG_OBJ_LENGTH = 1024;
const MJSONWP_ELEMENT_KEY = 'ELEMENT';
exports.MJSONWP_ELEMENT_KEY = MJSONWP_ELEMENT_KEY;
const W3C_ELEMENT_KEY = 'element-6066-11e4-a52e-4f735466cecf';
exports.W3C_ELEMENT_KEY = W3C_ELEMENT_KEY;
const IMAGE_ELEMENT_PREFIX = 'appium-image-element-';
exports.IMAGE_ELEMENT_PREFIX = IMAGE_ELEMENT_PREFIX;
const CREATE_SESSION_COMMAND = 'createSession';
const DELETE_SESSION_COMMAND = 'deleteSession';
const IMG_EL_BODY_RE = new RegExp(`"(${W3C_ELEMENT_KEY}|${MJSONWP_ELEMENT_KEY})":\s*` + `"${IMAGE_ELEMENT_PREFIX}[^"]+"`);
const IMG_EL_URL_RE = new RegExp(`/(element|screenshot)` + `/${IMAGE_ELEMENT_PREFIX}[^/]+`);

class Protocol {}

exports.Protocol = Protocol;

class SessionsCache {
  constructor(max) {
    this._cache = new _lruCache.default({
      max
    });
  }

  getLogger(sessionId, protocol) {
    if (sessionId) {
      if (this._cache.has(sessionId)) {
        const value = this._cache.get(sessionId);

        if (value.logger) {
          return value.logger;
        }

        protocol = protocol || value.protocol;
      }

      return _appiumSupport.logger.getLogger(`${protocol || GENERIC_PROTOCOL} ` + `(${sessionId.substring(0, Math.min(sessionId.length, 8))})`);
    }

    switch (protocol) {
      case _driver.default.DRIVER_PROTOCOL.W3C:
        return w3cLog;

      case _driver.default.DRIVER_PROTOCOL.MJSONWP:
        return mjsonwpLog;

      default:
        return genericProtocolLog;
    }
  }

  getProtocol(sessionId) {
    return (this._cache.get(sessionId) || {}).protocol;
  }

  putSession(sessionId, value) {
    if (sessionId && value) {
      this._cache.set(sessionId, {
        protocol: value,
        logger: this.getLogger(sessionId, value)
      });
    }

    return value;
  }

  resetLogger(sessionId) {
    if (this._cache.has(sessionId)) {
      this._cache.get(sessionId).logger = null;
    }
  }

}

const SESSIONS_CACHE = new SessionsCache(100);

function extractProtocol(driver, sessionId = null) {
  const dstDriver = _lodash.default.isFunction(driver.driverForSession) ? driver.driverForSession(sessionId) : driver;

  if (dstDriver === driver) {
    return driver.protocol;
  }

  return dstDriver ? dstDriver.protocol : SESSIONS_CACHE.getProtocol(sessionId);
}

function isSessionCommand(command) {
  return !_lodash.default.includes(_routes.NO_SESSION_ID_COMMANDS, command);
}

function wrapParams(paramSets, jsonObj) {
  let res = jsonObj;

  if (_lodash.default.isArray(jsonObj) || !_lodash.default.isObject(jsonObj)) {
    res = {};
    res[paramSets.wrap] = jsonObj;
  }

  return res;
}

function unwrapParams(paramSets, jsonObj) {
  let res = jsonObj;

  if (_lodash.default.isObject(jsonObj)) {
    if (jsonObj[paramSets.unwrap]) {
      res = jsonObj[paramSets.unwrap];
    }
  }

  return res;
}

function checkParams(paramSets, jsonObj, protocol) {
  let requiredParams = [];
  let optionalParams = [];

  let receivedParams = _lodash.default.keys(jsonObj);

  if (paramSets) {
    if (paramSets.required) {
      if (!_lodash.default.isArray(_lodash.default.first(paramSets.required))) {
        requiredParams = [paramSets.required];
      } else {
        requiredParams = paramSets.required;
      }
    }

    if (paramSets.optional) {
      optionalParams = paramSets.optional;
    }

    if (paramSets.validate) {
      let message = paramSets.validate(jsonObj, protocol);

      if (message) {
        throw new _errors.errors.BadParametersError(message, jsonObj);
      }
    }
  }

  if (requiredParams.length === 0) {
    return;
  }

  if (optionalParams.indexOf('sessionId') === -1) {
    optionalParams.push('sessionId');
  }

  if (optionalParams.indexOf('id') === -1) {
    optionalParams.push('id');
  }

  for (let params of requiredParams) {
    if (_lodash.default.difference(receivedParams, params, optionalParams).length === 0 && _lodash.default.difference(params, receivedParams).length === 0) {
      return;
    }
  }

  throw new _errors.errors.BadParametersError(paramSets, receivedParams);
}

function makeArgs(requestParams, jsonObj, payloadParams, protocol) {
  let urlParams = _lodash.default.keys(requestParams).reverse();

  let requiredParams = payloadParams.required;

  if (_lodash.default.isArray(_lodash.default.first(payloadParams.required))) {
    let keys = _lodash.default.keys(jsonObj);

    for (let params of payloadParams.required) {
      if (_lodash.default.without(params, ...keys).length === 0) {
        requiredParams = params;
        break;
      }
    }
  }

  let args;

  if (_lodash.default.isFunction(payloadParams.makeArgs)) {
    args = payloadParams.makeArgs(jsonObj, protocol);
  } else {
    args = _lodash.default.flatten(requiredParams).map(p => jsonObj[p]);

    if (payloadParams.optional) {
      args = args.concat(_lodash.default.flatten(payloadParams.optional).map(p => jsonObj[p]));
    }
  }

  args = args.concat(urlParams.map(u => requestParams[u]));
  return args;
}

function routeConfiguringFunction(driver) {
  if (!driver.sessionExists) {
    throw new Error('Drivers used with MJSONWP must implement `sessionExists`');
  }

  if (!(driver.executeCommand || driver.execute)) {
    throw new Error('Drivers used with MJSONWP must implement `executeCommand` or `execute`');
  }

  return function (app) {
    for (let [path, methods] of _lodash.default.toPairs(_routes.METHOD_MAP)) {
      for (let [method, spec] of _lodash.default.toPairs(methods)) {
        buildHandler(app, method, path, spec, driver, isSessionCommand(spec.command));
      }
    }
  };
}

function buildHandler(app, method, path, spec, driver, isSessCmd) {
  let asyncHandler = async (req, res) => {
    let jsonObj = req.body;
    let httpResBody = {};
    let httpStatus = 200;
    let newSessionId;
    let currentProtocol = extractProtocol(driver, req.params.sessionId);

    try {
      if (isSessCmd && !driver.sessionExists(req.params.sessionId)) {
        throw new _errors.errors.NoSuchDriverError();
      }

      if (isSessCmd && driverShouldDoJwpProxy(driver, req, spec.command)) {
        await doJwpProxy(driver, req, res);
        return;
      }

      if (!spec.command) {
        throw new _errors.errors.NotImplementedError();
      }

      if (spec.payloadParams && spec.payloadParams.wrap) {
        jsonObj = wrapParams(spec.payloadParams, jsonObj);
      }

      if (spec.payloadParams && spec.payloadParams.unwrap) {
        jsonObj = unwrapParams(spec.payloadParams, jsonObj);
      }

      if (spec.command === CREATE_SESSION_COMMAND) {
        currentProtocol = _driver.default.determineProtocol(...makeArgs(req.params, jsonObj, spec.payloadParams || {}));
      }

      checkParams(spec.payloadParams, jsonObj, currentProtocol);
      let args = makeArgs(req.params, jsonObj, spec.payloadParams || {}, currentProtocol);
      let driverRes;

      if (_validators.validators[spec.command]) {
        _validators.validators[spec.command](...args);
      }

      SESSIONS_CACHE.getLogger(req.params.sessionId, currentProtocol).debug(`Calling ` + `${driver.constructor.name}.${spec.command}() with args: ` + _lodash.default.truncate(JSON.stringify(args), {
        length: LOG_OBJ_LENGTH
      }));

      if (driver.executeCommand) {
        driverRes = await driver.executeCommand(spec.command, ...args);
      } else {
        driverRes = await driver.execute(spec.command, ...args);
      }

      currentProtocol = extractProtocol(driver, req.params.sessionId) || currentProtocol;

      if (_lodash.default.isPlainObject(driverRes) && _lodash.default.has(driverRes, 'protocol')) {
        currentProtocol = driverRes.protocol || currentProtocol;

        if (driverRes.error) {
          throw driverRes.error;
        }

        driverRes = driverRes.value;
      }

      if (spec.command === CREATE_SESSION_COMMAND) {
        newSessionId = driverRes[0];
        SESSIONS_CACHE.putSession(newSessionId, currentProtocol);
        SESSIONS_CACHE.getLogger(newSessionId, currentProtocol).debug(`Cached the protocol value '${currentProtocol}' for the new session ${newSessionId}`);

        if (currentProtocol === _driver.default.DRIVER_PROTOCOL.MJSONWP) {
          driverRes = driverRes[1];
        } else if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
          driverRes = {
            capabilities: driverRes[1]
          };
        }
      }

      if (driverRes) {
        if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
          driverRes = (0, _helpers.renameKey)(driverRes, MJSONWP_ELEMENT_KEY, W3C_ELEMENT_KEY);
        } else {
          driverRes = (0, _helpers.renameKey)(driverRes, W3C_ELEMENT_KEY, MJSONWP_ELEMENT_KEY);
        }
      }

      if (_lodash.default.isUndefined(driverRes)) {
        driverRes = null;
      }

      if (spec.command === DELETE_SESSION_COMMAND) {
        SESSIONS_CACHE.getLogger(req.params.sessionId, currentProtocol).debug(`Received response: ${_lodash.default.truncate(JSON.stringify(driverRes), {
          length: LOG_OBJ_LENGTH
        })}`);
        SESSIONS_CACHE.getLogger(req.params.sessionId, currentProtocol).debug('But deleting session, so not returning');
        driverRes = null;
      }

      if (_appiumSupport.util.hasValue(driverRes)) {
        if (_appiumSupport.util.hasValue(driverRes.status) && !isNaN(driverRes.status) && parseInt(driverRes.status, 10) !== 0) {
          throw (0, _errors.errorFromMJSONWPStatusCode)(driverRes.status, driverRes.value);
        } else if (_lodash.default.isPlainObject(driverRes.value) && driverRes.value.error) {
          throw (0, _errors.errorFromW3CJsonCode)(driverRes.value.error, driverRes.value.message, driverRes.value.stacktrace);
        }
      }

      if (currentProtocol !== _driver.default.DRIVER_PROTOCOL.W3C) {
        httpResBody.status = _lodash.default.isNil(driverRes) || _lodash.default.isUndefined(driverRes.status) ? JSONWP_SUCCESS_STATUS_CODE : driverRes.status;
      }

      httpResBody.value = driverRes;
      SESSIONS_CACHE.getLogger(req.params.sessionId || newSessionId, currentProtocol).debug(`Responding ` + `to client with driver.${spec.command}() result: ${_lodash.default.truncate(JSON.stringify(driverRes), {
        length: LOG_OBJ_LENGTH
      })}`);

      if (spec.command === DELETE_SESSION_COMMAND) {
        SESSIONS_CACHE.resetLogger(req.params.sessionId);
      }
    } catch (err) {
      let actualErr = err;
      currentProtocol = currentProtocol || extractProtocol(driver, req.params.sessionId || newSessionId);
      let errMsg = err.stacktrace || err.stack;

      if (!_lodash.default.includes(errMsg, err.message)) {
        errMsg = `${err.message}${errMsg ? '\n' + errMsg : ''}`;
      }

      SESSIONS_CACHE.getLogger(req.params.sessionId || newSessionId, currentProtocol).debug(`Encountered ` + `internal error running command: ${errMsg}`);

      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        actualErr = err.getActualError();
      }

      if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
        [httpStatus, httpResBody] = (0, _errors.getResponseForW3CError)(actualErr);
      } else if (currentProtocol === _driver.default.DRIVER_PROTOCOL.MJSONWP) {
        [httpStatus, httpResBody] = (0, _errors.getResponseForJsonwpError)(actualErr);
      } else {
        let jsonwpRes = (0, _errors.getResponseForJsonwpError)(actualErr);
        let w3cRes = (0, _errors.getResponseForW3CError)(actualErr);
        httpResBody = (0, _objectSpread2.default)({}, jsonwpRes[1], w3cRes[1]);
        httpStatus = jsonwpRes[0];
      }
    }

    if (_lodash.default.isString(httpResBody)) {
      res.status(httpStatus).send(httpResBody);
    } else {
      if (newSessionId) {
        if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
          httpResBody.value.sessionId = newSessionId;
        } else {
          httpResBody.sessionId = newSessionId;
        }
      } else {
        httpResBody.sessionId = req.params.sessionId || null;
      }

      if (currentProtocol === _driver.default.DRIVER_PROTOCOL.W3C) {
        delete httpResBody.sessionId;
      }

      res.status(httpStatus).json(httpResBody);
    }
  };

  app[method.toLowerCase()](path, (req, res) => {
    _bluebird.default.resolve(asyncHandler(req, res)).done();
  });
}

function driverShouldDoJwpProxy(driver, req, command) {
  if (!driver.proxyActive(req.params.sessionId)) {
    return false;
  }

  if (command === 'deleteSession') {
    return false;
  }

  if (driver.proxyRouteIsAvoided(req.params.sessionId, req.method, req.originalUrl)) {
    return false;
  }

  if (IMG_EL_URL_RE.test(req.originalUrl)) {
    return false;
  }

  const stringBody = JSON.stringify(req.body);

  if (stringBody && IMG_EL_BODY_RE.test(stringBody)) {
    return false;
  }

  return true;
}

async function doJwpProxy(driver, req, res) {
  SESSIONS_CACHE.getLogger(req.params.sessionId, extractProtocol(driver, req.params.sessionId)).info('Driver proxy active, passing request on via HTTP proxy');

  if (!driver.canProxy(req.params.sessionId)) {
    throw new Error('Trying to proxy to a JSONWP server but driver is unable to proxy');
  }

  try {
    const proxiedRes = await driver.executeCommand('proxyReqRes', req, res, req.params.sessionId);
    if (proxiedRes && proxiedRes.error) throw proxiedRes.error;
  } catch (err) {
    if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
      throw err;
    } else {
      throw new Error(`Could not proxy. Proxy error: ${err.message}`);
    }
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9wcm90b2NvbC9wcm90b2NvbC5qcyJdLCJuYW1lcyI6WyJHRU5FUklDX1BST1RPQ09MIiwibWpzb253cExvZyIsImxvZ2dlciIsImdldExvZ2dlciIsInczY0xvZyIsImdlbmVyaWNQcm90b2NvbExvZyIsIkpTT05XUF9TVUNDRVNTX1NUQVRVU19DT0RFIiwiTE9HX09CSl9MRU5HVEgiLCJNSlNPTldQX0VMRU1FTlRfS0VZIiwiVzNDX0VMRU1FTlRfS0VZIiwiSU1BR0VfRUxFTUVOVF9QUkVGSVgiLCJDUkVBVEVfU0VTU0lPTl9DT01NQU5EIiwiREVMRVRFX1NFU1NJT05fQ09NTUFORCIsIklNR19FTF9CT0RZX1JFIiwiUmVnRXhwIiwiSU1HX0VMX1VSTF9SRSIsIlByb3RvY29sIiwiU2Vzc2lvbnNDYWNoZSIsImNvbnN0cnVjdG9yIiwibWF4IiwiX2NhY2hlIiwiTFJVIiwic2Vzc2lvbklkIiwicHJvdG9jb2wiLCJoYXMiLCJ2YWx1ZSIsImdldCIsInN1YnN0cmluZyIsIk1hdGgiLCJtaW4iLCJsZW5ndGgiLCJCYXNlRHJpdmVyIiwiRFJJVkVSX1BST1RPQ09MIiwiVzNDIiwiTUpTT05XUCIsImdldFByb3RvY29sIiwicHV0U2Vzc2lvbiIsInNldCIsInJlc2V0TG9nZ2VyIiwiU0VTU0lPTlNfQ0FDSEUiLCJleHRyYWN0UHJvdG9jb2wiLCJkcml2ZXIiLCJkc3REcml2ZXIiLCJfIiwiaXNGdW5jdGlvbiIsImRyaXZlckZvclNlc3Npb24iLCJpc1Nlc3Npb25Db21tYW5kIiwiY29tbWFuZCIsImluY2x1ZGVzIiwiTk9fU0VTU0lPTl9JRF9DT01NQU5EUyIsIndyYXBQYXJhbXMiLCJwYXJhbVNldHMiLCJqc29uT2JqIiwicmVzIiwiaXNBcnJheSIsImlzT2JqZWN0Iiwid3JhcCIsInVud3JhcFBhcmFtcyIsInVud3JhcCIsImNoZWNrUGFyYW1zIiwicmVxdWlyZWRQYXJhbXMiLCJvcHRpb25hbFBhcmFtcyIsInJlY2VpdmVkUGFyYW1zIiwia2V5cyIsInJlcXVpcmVkIiwiZmlyc3QiLCJvcHRpb25hbCIsInZhbGlkYXRlIiwibWVzc2FnZSIsImVycm9ycyIsIkJhZFBhcmFtZXRlcnNFcnJvciIsImluZGV4T2YiLCJwdXNoIiwicGFyYW1zIiwiZGlmZmVyZW5jZSIsIm1ha2VBcmdzIiwicmVxdWVzdFBhcmFtcyIsInBheWxvYWRQYXJhbXMiLCJ1cmxQYXJhbXMiLCJyZXZlcnNlIiwid2l0aG91dCIsImFyZ3MiLCJmbGF0dGVuIiwibWFwIiwicCIsImNvbmNhdCIsInUiLCJyb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24iLCJzZXNzaW9uRXhpc3RzIiwiRXJyb3IiLCJleGVjdXRlQ29tbWFuZCIsImV4ZWN1dGUiLCJhcHAiLCJwYXRoIiwibWV0aG9kcyIsInRvUGFpcnMiLCJNRVRIT0RfTUFQIiwibWV0aG9kIiwic3BlYyIsImJ1aWxkSGFuZGxlciIsImlzU2Vzc0NtZCIsImFzeW5jSGFuZGxlciIsInJlcSIsImJvZHkiLCJodHRwUmVzQm9keSIsImh0dHBTdGF0dXMiLCJuZXdTZXNzaW9uSWQiLCJjdXJyZW50UHJvdG9jb2wiLCJOb1N1Y2hEcml2ZXJFcnJvciIsImRyaXZlclNob3VsZERvSndwUHJveHkiLCJkb0p3cFByb3h5IiwiTm90SW1wbGVtZW50ZWRFcnJvciIsImRldGVybWluZVByb3RvY29sIiwiZHJpdmVyUmVzIiwidmFsaWRhdG9ycyIsImRlYnVnIiwibmFtZSIsInRydW5jYXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsImlzUGxhaW5PYmplY3QiLCJlcnJvciIsImNhcGFiaWxpdGllcyIsImlzVW5kZWZpbmVkIiwidXRpbCIsImhhc1ZhbHVlIiwic3RhdHVzIiwiaXNOYU4iLCJwYXJzZUludCIsInN0YWNrdHJhY2UiLCJpc05pbCIsImVyciIsImFjdHVhbEVyciIsImVyck1zZyIsInN0YWNrIiwiUHJveHlSZXF1ZXN0RXJyb3IiLCJnZXRBY3R1YWxFcnJvciIsImpzb253cFJlcyIsInczY1JlcyIsImlzU3RyaW5nIiwic2VuZCIsImpzb24iLCJ0b0xvd2VyQ2FzZSIsIkIiLCJyZXNvbHZlIiwiZG9uZSIsInByb3h5QWN0aXZlIiwicHJveHlSb3V0ZUlzQXZvaWRlZCIsIm9yaWdpbmFsVXJsIiwidGVzdCIsInN0cmluZ0JvZHkiLCJpbmZvIiwiY2FuUHJveHkiLCJwcm94aWVkUmVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUcsU0FBekI7O0FBQ0EsTUFBTUMsVUFBVSxHQUFHQyxzQkFBT0MsU0FBUCxDQUFpQixTQUFqQixDQUFuQjs7QUFDQSxNQUFNQyxNQUFNLEdBQUdGLHNCQUFPQyxTQUFQLENBQWlCLEtBQWpCLENBQWY7O0FBQ0EsTUFBTUUsa0JBQWtCLEdBQUdILHNCQUFPQyxTQUFQLENBQWlCSCxnQkFBakIsQ0FBM0I7O0FBRUEsTUFBTU0sMEJBQTBCLEdBQUcsQ0FBbkM7QUFFQSxNQUFNQyxjQUFjLEdBQUcsSUFBdkI7QUFFQSxNQUFNQyxtQkFBbUIsR0FBRyxTQUE1Qjs7QUFDQSxNQUFNQyxlQUFlLEdBQUcscUNBQXhCOztBQUNBLE1BQU1DLG9CQUFvQixHQUFHLHVCQUE3Qjs7QUFFQSxNQUFNQyxzQkFBc0IsR0FBRyxlQUEvQjtBQUNBLE1BQU1DLHNCQUFzQixHQUFHLGVBQS9CO0FBRUEsTUFBTUMsY0FBYyxHQUFHLElBQUlDLE1BQUosQ0FDcEIsS0FBSUwsZUFBZ0IsSUFBR0QsbUJBQW9CLFFBQTVDLEdBQ0MsSUFBR0Usb0JBQXFCLFFBRkosQ0FBdkI7QUFJQSxNQUFNSyxhQUFhLEdBQUcsSUFBSUQsTUFBSixDQUNuQix1QkFBRCxHQUNDLElBQUdKLG9CQUFxQixPQUZMLENBQXRCOztBQUtBLE1BQU1NLFFBQU4sQ0FBZTs7OztBQUVmLE1BQU1DLGFBQU4sQ0FBb0I7QUFDbEJDLEVBQUFBLFdBQVcsQ0FBRUMsR0FBRixFQUFPO0FBQ2hCLFNBQUtDLE1BQUwsR0FBYyxJQUFJQyxpQkFBSixD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eyBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyB2YWxpZGF0b3JzIH0gZnJvbSAnLi92YWxpZGF0b3JzJztcbmltcG9ydCB7IGVycm9ycywgaXNFcnJvclR5cGUsIGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlLCBlcnJvckZyb21XM0NKc29uQ29kZSxcbiAgICAgICAgIGdldFJlc3BvbnNlRm9yVzNDRXJyb3IsIGdldFJlc3BvbnNlRm9ySnNvbndwRXJyb3IgfSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgeyBNRVRIT0RfTUFQLCBOT19TRVNTSU9OX0lEX0NPTU1BTkRTIH0gZnJvbSAnLi9yb3V0ZXMnO1xuaW1wb3J0IHsgcmVuYW1lS2V5IH0gZnJvbSAnLi4vYmFzZWRyaXZlci9oZWxwZXJzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBCYXNlRHJpdmVyIGZyb20gJy4uL2Jhc2Vkcml2ZXIvZHJpdmVyJztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcblxuY29uc3QgR0VORVJJQ19QUk9UT0NPTCA9ICdHRU5FUklDJztcbmNvbnN0IG1qc29ud3BMb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdNSlNPTldQJyk7XG5jb25zdCB3M2NMb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdXM0MnKTtcbmNvbnN0IGdlbmVyaWNQcm90b2NvbExvZyA9IGxvZ2dlci5nZXRMb2dnZXIoR0VORVJJQ19QUk9UT0NPTCk7XG5cbmNvbnN0IEpTT05XUF9TVUNDRVNTX1NUQVRVU19DT0RFID0gMDtcbi8vIFRPRE86IE1ha2UgdGhpcyB2YWx1ZSBjb25maWd1cmFibGUgYXMgYSBzZXJ2ZXIgc2lkZSBjYXBhYmlsaXR5XG5jb25zdCBMT0dfT0JKX0xFTkdUSCA9IDEwMjQ7IC8vIE1BWCBMRU5HVEggTG9nZ2VkIHRvIGZpbGUgLyBjb25zb2xlXG5cbmNvbnN0IE1KU09OV1BfRUxFTUVOVF9LRVkgPSAnRUxFTUVOVCc7XG5jb25zdCBXM0NfRUxFTUVOVF9LRVkgPSAnZWxlbWVudC02MDY2LTExZTQtYTUyZS00ZjczNTQ2NmNlY2YnO1xuY29uc3QgSU1BR0VfRUxFTUVOVF9QUkVGSVggPSAnYXBwaXVtLWltYWdlLWVsZW1lbnQtJztcblxuY29uc3QgQ1JFQVRFX1NFU1NJT05fQ09NTUFORCA9ICdjcmVhdGVTZXNzaW9uJztcbmNvbnN0IERFTEVURV9TRVNTSU9OX0NPTU1BTkQgPSAnZGVsZXRlU2Vzc2lvbic7XG5cbmNvbnN0IElNR19FTF9CT0RZX1JFID0gbmV3IFJlZ0V4cChcbiAgYFwiKCR7VzNDX0VMRU1FTlRfS0VZfXwke01KU09OV1BfRUxFTUVOVF9LRVl9KVwiOlxccypgICsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11c2VsZXNzLWVzY2FwZVxuICBgXCIke0lNQUdFX0VMRU1FTlRfUFJFRklYfVteXCJdK1wiYFxuKTtcbmNvbnN0IElNR19FTF9VUkxfUkUgPSBuZXcgUmVnRXhwKFxuICBgLyhlbGVtZW50fHNjcmVlbnNob3QpYCArXG4gIGAvJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH1bXi9dK2Bcbik7XG5cbmNsYXNzIFByb3RvY29sIHt9XG5cbmNsYXNzIFNlc3Npb25zQ2FjaGUge1xuICBjb25zdHJ1Y3RvciAobWF4KSB7XG4gICAgdGhpcy5fY2FjaGUgPSBuZXcgTFJVKHsgbWF4IH0pO1xuICB9XG5cbiAgZ2V0TG9nZ2VyIChzZXNzaW9uSWQsIHByb3RvY29sKSB7XG4gICAgaWYgKHNlc3Npb25JZCkge1xuICAgICAgaWYgKHRoaXMuX2NhY2hlLmhhcyhzZXNzaW9uSWQpKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fY2FjaGUuZ2V0KHNlc3Npb25JZCk7XG4gICAgICAgIGlmICh2YWx1ZS5sb2dnZXIpIHtcbiAgICAgICAgICByZXR1cm4gdmFsdWUubG9nZ2VyO1xuICAgICAgICB9XG4gICAgICAgIHByb3RvY29sID0gcHJvdG9jb2wgfHwgdmFsdWUucHJvdG9jb2w7XG4gICAgICB9XG4gICAgICAvLyBBbHdheXMgY3JlYXRlIGEgbmV3IGxvZ2dlciBpbnN0YW5jZSBmb3IgaWRzXG4gICAgICAvLyB0aGF0IGFyZSBub3QgaW4gdGhlIGN1cnJlbnQgc2Vzc2lvbnMgbGlzdCxcbiAgICAgIC8vIHNvIHdlIGNhbiBzdGlsbCBzZWUgc3VjaCBpZHMgYXMgcHJlZml4ZXNcbiAgICAgIHJldHVybiBsb2dnZXIuZ2V0TG9nZ2VyKGAke3Byb3RvY29sIHx8IEdFTkVSSUNfUFJPVE9DT0x9IGAgK1xuICAgICAgICBgKCR7c2Vzc2lvbklkLnN1YnN0cmluZygwLCBNYXRoLm1pbihzZXNzaW9uSWQubGVuZ3RoLCA4KSl9KWApO1xuICAgIH1cblxuICAgIC8vIEZhbGwgYmFjayB0byBwcm90b2NvbCBuYW1lLW9ubHkgbG9nZ2VyIGlmIHNlc3Npb24gaWQgaXMgdW5rbm93blxuICAgIHN3aXRjaCAocHJvdG9jb2wpIHtcbiAgICAgIGNhc2UgQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDOlxuICAgICAgICByZXR1cm4gdzNjTG9nO1xuICAgICAgY2FzZSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5NSlNPTldQOlxuICAgICAgICByZXR1cm4gbWpzb253cExvZztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBnZW5lcmljUHJvdG9jb2xMb2c7XG4gICAgfVxuICB9XG5cbiAgZ2V0UHJvdG9jb2wgKHNlc3Npb25JZCkge1xuICAgIHJldHVybiAodGhpcy5fY2FjaGUuZ2V0KHNlc3Npb25JZCkgfHwge30pLnByb3RvY29sO1xuICB9XG5cbiAgcHV0U2Vzc2lvbiAoc2Vzc2lvbklkLCB2YWx1ZSkge1xuICAgIGlmIChzZXNzaW9uSWQgJiYgdmFsdWUpIHtcbiAgICAgIHRoaXMuX2NhY2hlLnNldChzZXNzaW9uSWQsIHtcbiAgICAgICAgcHJvdG9jb2w6IHZhbHVlLFxuICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRvIGNhY2hlIHRoZSBsb2dnZXIgaW5zdGFuY2UgZm9yIGVhY2ggcmFuZG9tIHNlc3Npb24gaWQgaW4gdGhlIGNhY2hlXG4gICAgICAgIC8vIGluIG9yZGVyIHRvIHNhdmUgbWVtb3J5LiBJbnN0ZWFkIHdlIG9ubHkgY2FjaGUgbG9nZ2VycyBmb3IgdmFsaWQgaWRzIHRoYXRcbiAgICAgICAgLy8gYXJlIHJldHVybmVkIGJ5IGBjcmVhdGVTZXNzaW9uYCBjYWxsIGFuZCByZXNldCB0aGVtIGFmdGVyIGBkZWxldGVTZXNzaW9uYCBpcyBjYWxsZWRcbiAgICAgICAgbG9nZ2VyOiB0aGlzLmdldExvZ2dlcihzZXNzaW9uSWQsIHZhbHVlKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICByZXNldExvZ2dlciAoc2Vzc2lvbklkKSB7XG4gICAgaWYgKHRoaXMuX2NhY2hlLmhhcyhzZXNzaW9uSWQpKSB7XG4gICAgICB0aGlzLl9jYWNoZS5nZXQoc2Vzc2lvbklkKS5sb2dnZXIgPSBudWxsO1xuICAgIH1cbiAgfVxufVxuXG4vLyBUaGlzIGNhY2hlIGlzIHVzZWZ1bCB3aGVuIGEgc2Vzc2lvbiBnZXRzIHRlcm1pbmF0ZWRcbi8vIGFuZCByZW1vdmVkIGZyb20gdGhlIHNlc3Npb25zIGxpc3QgaW4gdGhlIHVtYnJlbGxhIGRyaXZlcixcbi8vIGJ1dCB0aGUgY2xpZW50IHN0aWxsIHRyaWVzIHRvIHNlbmQgYSBjb21tYW5kIHRvIHRoaXMgc2Vzc2lvbiBpZC5cbi8vIFNvIHdlIGtub3cgaG93IHRvIHByb3Blcmx5IHdyYXAgdGhlIGVycm9yIG1lc3NhZ2UgZm9yIGl0XG5jb25zdCBTRVNTSU9OU19DQUNIRSA9IG5ldyBTZXNzaW9uc0NhY2hlKDEwMCk7XG5cblxuZnVuY3Rpb24gZXh0cmFjdFByb3RvY29sIChkcml2ZXIsIHNlc3Npb25JZCA9IG51bGwpIHtcbiAgY29uc3QgZHN0RHJpdmVyID0gXy5pc0Z1bmN0aW9uKGRyaXZlci5kcml2ZXJGb3JTZXNzaW9uKVxuICAgID8gZHJpdmVyLmRyaXZlckZvclNlc3Npb24oc2Vzc2lvbklkKVxuICAgIDogZHJpdmVyO1xuICBpZiAoZHN0RHJpdmVyID09PSBkcml2ZXIpIHtcbiAgICAvLyBTaG9ydGNpcmN1aXQgaWYgdGhlIGRyaXZlciBpbnN0YW5jZSBpcyBub3QgYW4gdW1icmVsbGEgZHJpdmVyXG4gICAgLy8gb3IgaXQgaXMgRmFrZSBkcml2ZXIgaW5zdGFuY2UsIHdoZXJlIGBkcml2ZXIuZHJpdmVyRm9yU2Vzc2lvbmBcbiAgICAvLyBhbHdheXMgcmV0dXJucyBzZWxmIGluc3RhbmNlXG4gICAgcmV0dXJuIGRyaXZlci5wcm90b2NvbDtcbiAgfVxuXG4gIC8vIEV4dHJhY3QgdGhlIHByb3RvY29sIGZvciB0aGUgY3VycmVudCBzZXNzaW9uIGlmIHRoZSBnaXZlbiBkcml2ZXIgaXMgdGhlIHVtYnJlbGxhIG9uZVxuICByZXR1cm4gZHN0RHJpdmVyID8gZHN0RHJpdmVyLnByb3RvY29sIDogU0VTU0lPTlNfQ0FDSEUuZ2V0UHJvdG9jb2woc2Vzc2lvbklkKTtcbn1cblxuZnVuY3Rpb24gaXNTZXNzaW9uQ29tbWFuZCAoY29tbWFuZCkge1xuICByZXR1cm4gIV8uaW5jbHVkZXMoTk9fU0VTU0lPTl9JRF9DT01NQU5EUywgY29tbWFuZCk7XG59XG5cbmZ1bmN0aW9uIHdyYXBQYXJhbXMgKHBhcmFtU2V0cywganNvbk9iaikge1xuICAvKiBUaGVyZSBhcmUgY29tbWFuZHMgbGlrZSBwZXJmb3JtVG91Y2ggd2hpY2ggdGFrZSBhIHNpbmdsZSBwYXJhbWV0ZXIgKHByaW1pdGl2ZSB0eXBlIG9yIGFycmF5KS5cbiAgICogU29tZSBkcml2ZXJzIGNob29zZSB0byBwYXNzIHRoaXMgcGFyYW1ldGVyIGFzIGEgdmFsdWUgKGVnLiBbYWN0aW9uMSwgYWN0aW9uMi4uLl0pIHdoaWxlIG90aGVycyB0b1xuICAgKiB3cmFwIGl0IHdpdGhpbiBhbiBvYmplY3QoZWcnIHtnZXN0dXJlOiAgW2FjdGlvbjEsIGFjdGlvbjIuLi5dfSksIHdoaWNoIG1ha2VzIGl0IGhhcmQgdG8gdmFsaWRhdGUuXG4gICAqIFRoZSB3cmFwIG9wdGlvbiBpbiB0aGUgc3BlYyBlbmZvcmNlIHdyYXBwaW5nIGJlZm9yZSB2YWxpZGF0aW9uLCBzbyB0aGF0IGFsbCBwYXJhbXMgYXJlIHdyYXBwZWQgYXRcbiAgICogdGhlIHRpbWUgdGhleSBhcmUgdmFsaWRhdGVkIGFuZCBsYXRlciBwYXNzZWQgdG8gdGhlIGNvbW1hbmRzLlxuICAgKi9cbiAgbGV0IHJlcyA9IGpzb25PYmo7XG4gIGlmIChfLmlzQXJyYXkoanNvbk9iaikgfHwgIV8uaXNPYmplY3QoanNvbk9iaikpIHtcbiAgICByZXMgPSB7fTtcbiAgICByZXNbcGFyYW1TZXRzLndyYXBdID0ganNvbk9iajtcbiAgfVxuICByZXR1cm4gcmVzO1xufVxuXG5mdW5jdGlvbiB1bndyYXBQYXJhbXMgKHBhcmFtU2V0cywganNvbk9iaikge1xuICAvKiBUaGVyZSBhcmUgY29tbWFuZHMgbGlrZSBzZXROZXR3b3JrQ29ubmVjdGlvbiB3aGljaCBzZW5kIHBhcmFtZXRlcnMgd3JhcHBlZCBpbnNpZGUgYSBrZXkgc3VjaCBhc1xuICAgKiBcInBhcmFtZXRlcnNcIi4gVGhpcyBmdW5jdGlvbiB1bndyYXBzIHRoZW0gKGVnLiB7XCJwYXJhbWV0ZXJzXCI6IHtcInR5cGVcIjogMX19IGJlY29tZXMge1widHlwZVwiOiAxfSkuXG4gICAqL1xuICBsZXQgcmVzID0ganNvbk9iajtcbiAgaWYgKF8uaXNPYmplY3QoanNvbk9iaikpIHtcbiAgICAvLyBzb21lIGNsaWVudHMsIGxpa2UgcnVieSwgZG9uJ3Qgd3JhcFxuICAgIGlmIChqc29uT2JqW3BhcmFtU2V0cy51bndyYXBdKSB7XG4gICAgICByZXMgPSBqc29uT2JqW3BhcmFtU2V0cy51bndyYXBdO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzO1xufVxuXG5mdW5jdGlvbiBjaGVja1BhcmFtcyAocGFyYW1TZXRzLCBqc29uT2JqLCBwcm90b2NvbCkge1xuICBsZXQgcmVxdWlyZWRQYXJhbXMgPSBbXTtcbiAgbGV0IG9wdGlvbmFsUGFyYW1zID0gW107XG4gIGxldCByZWNlaXZlZFBhcmFtcyA9IF8ua2V5cyhqc29uT2JqKTtcblxuICBpZiAocGFyYW1TZXRzKSB7XG4gICAgaWYgKHBhcmFtU2V0cy5yZXF1aXJlZCkge1xuICAgICAgLy8gd2UgbWlnaHQgaGF2ZSBhbiBhcnJheSBvZiBwYXJhbWV0ZXJzLFxuICAgICAgLy8gb3IgYW4gYXJyYXkgb2YgYXJyYXlzIG9mIHBhcmFtZXRlcnMsIHNvIHN0YW5kYXJkaXplXG4gICAgICBpZiAoIV8uaXNBcnJheShfLmZpcnN0KHBhcmFtU2V0cy5yZXF1aXJlZCkpKSB7XG4gICAgICAgIHJlcXVpcmVkUGFyYW1zID0gW3BhcmFtU2V0cy5yZXF1aXJlZF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXF1aXJlZFBhcmFtcyA9IHBhcmFtU2V0cy5yZXF1aXJlZDtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gb3B0aW9uYWwgcGFyYW1ldGVycyBhcmUganVzdCBhbiBhcnJheVxuICAgIGlmIChwYXJhbVNldHMub3B0aW9uYWwpIHtcbiAgICAgIG9wdGlvbmFsUGFyYW1zID0gcGFyYW1TZXRzLm9wdGlvbmFsO1xuICAgIH1cblxuICAgIC8vIElmIGEgZnVuY3Rpb24gd2FzIHByb3ZpZGVkIGFzIHRoZSAndmFsaWRhdGUnIGtleSwgaXQgd2lsbCBoZXJlIGJlIGNhbGxlZCB3aXRoXG4gICAgLy8ganNvbk9iaiBhcyB0aGUgcGFyYW0uIElmIGl0IHJldHVybnMgc29tZXRoaW5nIGZhbHN5LCB2ZXJpZmljYXRpb24gd2lsbCBiZVxuICAgIC8vIGNvbnNpZGVyZWQgdG8gaGF2ZSBwYXNzZWQuIElmIGl0IHJldHVybnMgc29tZXRoaW5nIGVsc2UsIHRoYXQgd2lsbCBiZSB0aGVcbiAgICAvLyBhcmd1bWVudCB0byBhbiBlcnJvciB3aGljaCBpcyB0aHJvd24gdG8gdGhlIHVzZXJcbiAgICBpZiAocGFyYW1TZXRzLnZhbGlkYXRlKSB7XG4gICAgICBsZXQgbWVzc2FnZSA9IHBhcmFtU2V0cy52YWxpZGF0ZShqc29uT2JqLCBwcm90b2NvbCk7XG4gICAgICBpZiAobWVzc2FnZSkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLkJhZFBhcmFtZXRlcnNFcnJvcihtZXNzYWdlLCBqc29uT2JqKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBpZiB3ZSBoYXZlIG5vIHJlcXVpcmVkIHBhcmFtZXRlcnMsIGFsbCBpcyB3ZWxsXG4gIGlmIChyZXF1aXJlZFBhcmFtcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBzb21lIGNsaWVudHMgcGFzcyBpbiB0aGUgc2Vzc2lvbiBpZCBpbiB0aGUgcGFyYW1zXG4gIGlmIChvcHRpb25hbFBhcmFtcy5pbmRleE9mKCdzZXNzaW9uSWQnKSA9PT0gLTEpIHtcbiAgICBvcHRpb25hbFBhcmFtcy5wdXNoKCdzZXNzaW9uSWQnKTtcbiAgfVxuXG4gIC8vIHNvbWUgY2xpZW50cyBwYXNzIGluIGFuIGVsZW1lbnQgaWQgaW4gdGhlIHBhcmFtc1xuICBpZiAob3B0aW9uYWxQYXJhbXMuaW5kZXhPZignaWQnKSA9PT0gLTEpIHtcbiAgICBvcHRpb25hbFBhcmFtcy5wdXNoKCdpZCcpO1xuICB9XG5cbiAgLy8gZ28gdGhyb3VnaCB0aGUgcmVxdWlyZWQgcGFyYW1ldGVycyBhbmQgY2hlY2sgYWdhaW5zdCBvdXIgYXJndW1lbnRzXG4gIGZvciAobGV0IHBhcmFtcyBvZiByZXF1aXJlZFBhcmFtcykge1xuICAgIGlmIChfLmRpZmZlcmVuY2UocmVjZWl2ZWRQYXJhbXMsIHBhcmFtcywgb3B0aW9uYWxQYXJhbXMpLmxlbmd0aCA9PT0gMCAmJlxuICAgICAgICBfLmRpZmZlcmVuY2UocGFyYW1zLCByZWNlaXZlZFBhcmFtcykubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyB3ZSBoYXZlIGEgc2V0IG9mIHBhcmFtZXRlcnMgdGhhdCBpcyBjb3JyZWN0XG4gICAgICAvLyBzbyBzaG9ydC1jaXJjdWl0XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBlcnJvcnMuQmFkUGFyYW1ldGVyc0Vycm9yKHBhcmFtU2V0cywgcmVjZWl2ZWRQYXJhbXMpO1xufVxuXG4vKlxuICogVGhpcyBtZXRob2QgdGFrZXMgMyBwaWVjZXMgb2YgZGF0YTogcmVxdWVzdCBwYXJhbWV0ZXJzICgncmVxdWVzdFBhcmFtcycpLFxuICogYSByZXF1ZXN0IEpTT04gYm9keSAoJ2pzb25PYmonKSwgYW5kICdwYXlsb2FkUGFyYW1zJywgd2hpY2ggaXMgdGhlIHNlY3Rpb25cbiAqIGZyb20gdGhlIHJvdXRlIGRlZmluaXRpb24gZm9yIGEgcGFydGljdWxhciBlbmRwb2ludCB3aGljaCBoYXMgaW5zdHJ1Y3Rpb25zXG4gKiBvbiBoYW5kbGluZyBwYXJhbWV0ZXJzLiBUaGlzIG1ldGhvZCByZXR1cm5zIGFuIGFycmF5IG9mIGFyZ3VtZW50cyB3aGljaCB3aWxsXG4gKiBiZSBhcHBsaWVkIHRvIGEgY29tbWFuZC5cbiAqL1xuZnVuY3Rpb24gbWFrZUFyZ3MgKHJlcXVlc3RQYXJhbXMsIGpzb25PYmosIHBheWxvYWRQYXJhbXMsIHByb3RvY29sKSB7XG4gIC8vIFdlIHdhbnQgdG8gcGFzcyB0aGUgXCJ1cmxcIiBwYXJhbWV0ZXJzIHRvIHRoZSBjb21tYW5kcyBpbiByZXZlcnNlIG9yZGVyXG4gIC8vIHNpbmNlIHRoZSBjb21tYW5kIHdpbGwgc29tZXRpbWVzIHdhbnQgdG8gaWdub3JlLCBzYXksIHRoZSBzZXNzaW9uSWQuXG4gIC8vIFRoaXMgaGFzIHRoZSBlZmZlY3Qgb2YgcHV0dGluZyBzZXNzaW9uSWQgbGFzdCwgd2hpY2ggbWVhbnMgaW4gSlMgd2UgY2FuXG4gIC8vIG9taXQgaXQgZnJvbSB0aGUgZnVuY3Rpb24gc2lnbmF0dXJlIGlmIHdlJ3JlIG5vdCBnb2luZyB0byB1c2UgaXQuXG4gIGxldCB1cmxQYXJhbXMgPSBfLmtleXMocmVxdWVzdFBhcmFtcykucmV2ZXJzZSgpO1xuXG4gIC8vIEluIHRoZSBzaW1wbGUgY2FzZSwgdGhlIHJlcXVpcmVkIHBhcmFtZXRlcnMgYXJlIGEgYmFzaWMgYXJyYXkgaW5cbiAgLy8gcGF5bG9hZFBhcmFtcy5yZXF1aXJlZCwgc28gc3RhcnQgdGhlcmUuIEl0J3MgcG9zc2libGUgdGhhdCB0aGVyZSBhcmVcbiAgLy8gbXVsdGlwbGUgb3B0aW9uYWwgc2V0cyBvZiByZXF1aXJlZCBwYXJhbXMsIHRob3VnaCwgc28gaGFuZGxlIHRoYXQgY2FzZVxuICAvLyB0b28uXG4gIGxldCByZXF1aXJlZFBhcmFtcyA9IHBheWxvYWRQYXJhbXMucmVxdWlyZWQ7XG4gIGlmIChfLmlzQXJyYXkoXy5maXJzdChwYXlsb2FkUGFyYW1zLnJlcXVpcmVkKSkpIHtcbiAgICAvLyBJZiB0aGVyZSBhcmUgb3B0aW9uYWwgc2V0cyBvZiByZXF1aXJlZCBwYXJhbXMsIHRoZW4gd2Ugd2lsbCBoYXZlIGFuXG4gICAgLy8gYXJyYXkgb2YgYXJyYXlzIGluIHBheWxvYWRQYXJhbXMucmVxdWlyZWQsIHNvIGxvb3AgdGhyb3VnaCBlYWNoIHNldCBhbmRcbiAgICAvLyBwaWNrIHRoZSBvbmUgdGhhdCBtYXRjaGVzIHdoaWNoIEpTT04gcGFyYW1zIHdlcmUgYWN0dWFsbHkgc2VudC4gV2UndmVcbiAgICAvLyBhbHJlYWR5IGJlZW4gdGhyb3VnaCB2YWxpZGF0aW9uIHNvIHdlJ3JlIGd1YXJhbnRlZWQgdG8gZmluZCBhIG1hdGNoLlxuICAgIGxldCBrZXlzID0gXy5rZXlzKGpzb25PYmopO1xuICAgIGZvciAobGV0IHBhcmFtcyBvZiBwYXlsb2FkUGFyYW1zLnJlcXVpcmVkKSB7XG4gICAgICBpZiAoXy53aXRob3V0KHBhcmFtcywgLi4ua2V5cykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJlcXVpcmVkUGFyYW1zID0gcGFyYW1zO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBOb3cgd2UgY29uc3RydWN0IG91ciBsaXN0IG9mIGFyZ3VtZW50cyB3aGljaCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgY29tbWFuZFxuICBsZXQgYXJncztcbiAgaWYgKF8uaXNGdW5jdGlvbihwYXlsb2FkUGFyYW1zLm1ha2VBcmdzKSkge1xuICAgIC8vIEluIHRoZSByb3V0ZSBzcGVjLCBhIHBhcnRpY3VsYXIgcm91dGUgbWlnaHQgZGVmaW5lIGEgJ21ha2VBcmdzJyBmdW5jdGlvblxuICAgIC8vIGlmIGl0IHdhbnRzIGZ1bGwgY29udHJvbCBvdmVyIGhvdyB0byB0dXJuIEpTT04gcGFyYW1ldGVycyBpbnRvIGNvbW1hbmRcbiAgICAvLyBhcmd1bWVudHMuIFNvIHdlIHBhc3MgaXQgdGhlIEpTT04gcGFyYW1ldGVycyBhbmQgaXQgcmV0dXJucyBhbiBhcnJheVxuICAgIC8vIHdoaWNoIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgaGFuZGxpbmcgY29tbWFuZC4gRm9yIGV4YW1wbGUgaWYgaXQgcmV0dXJuc1xuICAgIC8vIFsxLCAyLCAzXSwgd2Ugd2lsbCBjYWxsIGBjb21tYW5kKDEsIDIsIDMsIC4uLilgICh1cmwgcGFyYW1zIGFyZSBzZXBhcmF0ZVxuICAgIC8vIGZyb20gSlNPTiBwYXJhbXMgYW5kIGdldCBjb25jYXRlbmF0ZWQgYmVsb3cpLlxuICAgIGFyZ3MgPSBwYXlsb2FkUGFyYW1zLm1ha2VBcmdzKGpzb25PYmosIHByb3RvY29sKTtcbiAgfSBlbHNlIHtcbiAgICAvLyBPdGhlcndpc2UsIGNvbGxlY3QgYWxsIHRoZSByZXF1aXJlZCBhbmQgb3B0aW9uYWwgcGFyYW1zIGFuZCBmbGF0dGVuIHRoZW1cbiAgICAvLyBpbnRvIGFuIGFyZ3VtZW50IGFycmF5XG4gICAgYXJncyA9IF8uZmxhdHRlbihyZXF1aXJlZFBhcmFtcykubWFwKChwKSA9PiBqc29uT2JqW3BdKTtcbiAgICBpZiAocGF5bG9hZFBhcmFtcy5vcHRpb25hbCkge1xuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KF8uZmxhdHRlbihwYXlsb2FkUGFyYW1zLm9wdGlvbmFsKS5tYXAoKHApID0+IGpzb25PYmpbcF0pKTtcbiAgICB9XG4gIH1cbiAgLy8gRmluYWxseSwgZ2V0IG91ciB1cmwgcGFyYW1zIChzZXNzaW9uIGlkLCBlbGVtZW50IGlkLCBldGMuLi4pIG9uIHRoZSBlbmQgb2ZcbiAgLy8gdGhlIGxpc3RcbiAgYXJncyA9IGFyZ3MuY29uY2F0KHVybFBhcmFtcy5tYXAoKHUpID0+IHJlcXVlc3RQYXJhbXNbdV0pKTtcbiAgcmV0dXJuIGFyZ3M7XG59XG5cbmZ1bmN0aW9uIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiAoZHJpdmVyKSB7XG4gIGlmICghZHJpdmVyLnNlc3Npb25FeGlzdHMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0RyaXZlcnMgdXNlZCB3aXRoIE1KU09OV1AgbXVzdCBpbXBsZW1lbnQgYHNlc3Npb25FeGlzdHNgJyk7XG4gIH1cblxuICBpZiAoIShkcml2ZXIuZXhlY3V0ZUNvbW1hbmQgfHwgZHJpdmVyLmV4ZWN1dGUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdEcml2ZXJzIHVzZWQgd2l0aCBNSlNPTldQIG11c3QgaW1wbGVtZW50IGBleGVjdXRlQ29tbWFuZGAgb3IgYGV4ZWN1dGVgJyk7XG4gIH1cblxuICAvLyByZXR1cm4gYSBmdW5jdGlvbiB3aGljaCB3aWxsIGFkZCBhbGwgdGhlIHJvdXRlcyB0byB0aGUgZHJpdmVyXG4gIHJldHVybiBmdW5jdGlvbiAoYXBwKSB7XG4gICAgZm9yIChsZXQgW3BhdGgsIG1ldGhvZHNdIG9mIF8udG9QYWlycyhNRVRIT0RfTUFQKSkge1xuICAgICAgZm9yIChsZXQgW21ldGhvZCwgc3BlY10gb2YgXy50b1BhaXJzKG1ldGhvZHMpKSB7XG4gICAgICAgIC8vIHNldCB1cCB0aGUgZXhwcmVzcyByb3V0ZSBoYW5kbGVyXG4gICAgICAgIGJ1aWxkSGFuZGxlcihhcHAsIG1ldGhvZCwgcGF0aCwgc3BlYywgZHJpdmVyLCBpc1Nlc3Npb25Db21tYW5kKHNwZWMuY29tbWFuZCkpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gYnVpbGRIYW5kbGVyIChhcHAsIG1ldGhvZCwgcGF0aCwgc3BlYywgZHJpdmVyLCBpc1Nlc3NDbWQpIHtcbiAgbGV0IGFzeW5jSGFuZGxlciA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGxldCBqc29uT2JqID0gcmVxLmJvZHk7XG4gICAgbGV0IGh0dHBSZXNCb2R5ID0ge307XG4gICAgbGV0IGh0dHBTdGF0dXMgPSAyMDA7XG4gICAgbGV0IG5ld1Nlc3Npb25JZDtcbiAgICBsZXQgY3VycmVudFByb3RvY29sID0gZXh0cmFjdFByb3RvY29sKGRyaXZlciwgcmVxLnBhcmFtcy5zZXNzaW9uSWQpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIGlmIHRoaXMgaXMgYSBzZXNzaW9uIGNvbW1hbmQgYnV0IHdlIGRvbid0IGhhdmUgYSBzZXNzaW9uLFxuICAgICAgLy8gZXJyb3Igb3V0IGVhcmx5IChlc3BlY2lhbGx5IGJlZm9yZSBwcm94eWluZylcbiAgICAgIGlmIChpc1Nlc3NDbWQgJiYgIWRyaXZlci5zZXNzaW9uRXhpc3RzKHJlcS5wYXJhbXMuc2Vzc2lvbklkKSkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaERyaXZlckVycm9yKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIHRoZSBkcml2ZXIgaXMgY3VycmVudGx5IHByb3h5aW5nIGNvbW1hbmRzIHRvIGFub3RoZXIgSlNPTldQXG4gICAgICAvLyBzZXJ2ZXIsIGJ5cGFzcyBhbGwgb3VyIGNoZWNrcyBhbmQgYXNzdW1lIHRoZSB1cHN0cmVhbSBzZXJ2ZXIga25vd3NcbiAgICAgIC8vIHdoYXQgaXQncyBkb2luZy4gQnV0IGtlZXAgdGhpcyBpbiB0aGUgdHJ5L2NhdGNoIGJsb2NrIHNvIGlmIHByb3h5aW5nXG4gICAgICAvLyBpdHNlbGYgZmFpbHMsIHdlIGdpdmUgYSBtZXNzYWdlIHRvIHRoZSBjbGllbnQuIE9mIGNvdXJzZSB3ZSBvbmx5XG4gICAgICAvLyB3YW50IHRvIGRvIHRoZXNlIHdoZW4gd2UgaGF2ZSBhIHNlc3Npb24gY29tbWFuZDsgdGhlIEFwcGl1bSBkcml2ZXJcbiAgICAgIC8vIG11c3QgYmUgcmVzcG9uc2libGUgZm9yIHN0YXJ0L3N0b3Agc2Vzc2lvbiwgZXRjLi4uXG4gICAgICBpZiAoaXNTZXNzQ21kICYmIGRyaXZlclNob3VsZERvSndwUHJveHkoZHJpdmVyLCByZXEsIHNwZWMuY29tbWFuZCkpIHtcbiAgICAgICAgYXdhaXQgZG9Kd3BQcm94eShkcml2ZXIsIHJlcSwgcmVzKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiBhIGNvbW1hbmQgaXMgbm90IGluIG91ciBtZXRob2QgbWFwLCBpdCdzIGJlY2F1c2Ugd2VcbiAgICAgIC8vIGhhdmUgbm8gcGxhbnMgdG8gZXZlciBpbXBsZW1lbnQgaXRcbiAgICAgIGlmICghc3BlYy5jb21tYW5kKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICAgICAgfVxuXG4gICAgICAvLyB3cmFwIHBhcmFtcyBpZiBuZWNlc3NhcnlcbiAgICAgIGlmIChzcGVjLnBheWxvYWRQYXJhbXMgJiYgc3BlYy5wYXlsb2FkUGFyYW1zLndyYXApIHtcbiAgICAgICAganNvbk9iaiA9IHdyYXBQYXJhbXMoc3BlYy5wYXlsb2FkUGFyYW1zLCBqc29uT2JqKTtcbiAgICAgIH1cblxuICAgICAgLy8gdW53cmFwIHBhcmFtcyBpZiBuZWNlc3NhcnlcbiAgICAgIGlmIChzcGVjLnBheWxvYWRQYXJhbXMgJiYgc3BlYy5wYXlsb2FkUGFyYW1zLnVud3JhcCkge1xuICAgICAgICBqc29uT2JqID0gdW53cmFwUGFyYW1zKHNwZWMucGF5bG9hZFBhcmFtcywganNvbk9iaik7XG4gICAgICB9XG5cbiAgICAgIGlmIChzcGVjLmNvbW1hbmQgPT09IENSRUFURV9TRVNTSU9OX0NPTU1BTkQpIHtcbiAgICAgICAgLy8gdHJ5IHRvIGRldGVybWluZSBwcm90b2NvbCBieSBzZXNzaW9uIGNyZWF0aW9uIGFyZ3MsIHNvIHdlIGNhbiB0aHJvdyBhXG4gICAgICAgIC8vIHByb3Blcmx5IGZvcm1hdHRlZCBlcnJvciBpZiBhcmd1bWVudHMgdmFsaWRhdGlvbiBmYWlsc1xuICAgICAgICBjdXJyZW50UHJvdG9jb2wgPSBCYXNlRHJpdmVyLmRldGVybWluZVByb3RvY29sKC4uLm1ha2VBcmdzKHJlcS5wYXJhbXMsIGpzb25PYmosIHNwZWMucGF5bG9hZFBhcmFtcyB8fCB7fSkpO1xuICAgICAgfVxuXG4gICAgICAvLyBlbnN1cmUgdGhhdCB0aGUganNvbiBwYXlsb2FkIGNvbmZvcm1zIHRvIHRoZSBzcGVjXG4gICAgICBjaGVja1BhcmFtcyhzcGVjLnBheWxvYWRQYXJhbXMsIGpzb25PYmosIGN1cnJlbnRQcm90b2NvbCk7XG5cbiAgICAgIC8vIHR1cm4gdGhlIGNvbW1hbmQgYW5kIGpzb24gcGF5bG9hZCBpbnRvIGFuIGFyZ3VtZW50IGxpc3QgZm9yXG4gICAgICAvLyB0aGUgZHJpdmVyIG1ldGhvZHNcbiAgICAgIGxldCBhcmdzID0gbWFrZUFyZ3MocmVxLnBhcmFtcywganNvbk9iaiwgc3BlYy5wYXlsb2FkUGFyYW1zIHx8IHt9LCBjdXJyZW50UHJvdG9jb2wpO1xuICAgICAgbGV0IGRyaXZlclJlcztcbiAgICAgIC8vIHZhbGlkYXRlIGNvbW1hbmQgYXJncyBhY2NvcmRpbmcgdG8gTUpTT05XUFxuICAgICAgaWYgKHZhbGlkYXRvcnNbc3BlYy5jb21tYW5kXSkge1xuICAgICAgICB2YWxpZGF0b3JzW3NwZWMuY29tbWFuZF0oLi4uYXJncyk7XG4gICAgICB9XG5cbiAgICAgIC8vIHJ1biB0aGUgZHJpdmVyIGNvbW1hbmQgd3JhcHBlZCBpbnNpZGUgdGhlIGFyZ3VtZW50IHZhbGlkYXRvcnNcbiAgICAgIFNFU1NJT05TX0NBQ0hFLmdldExvZ2dlcihyZXEucGFyYW1zLnNlc3Npb25JZCwgY3VycmVudFByb3RvY29sKS5kZWJ1ZyhgQ2FsbGluZyBgICtcbiAgICAgICAgYCR7ZHJpdmVyLmNvbnN0cnVjdG9yLm5hbWV9LiR7c3BlYy5jb21tYW5kfSgpIHdpdGggYXJnczogYCArXG4gICAgICAgIF8udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoYXJncyksIHtsZW5ndGg6IExPR19PQkpfTEVOR1RIfSkpO1xuXG4gICAgICBpZiAoZHJpdmVyLmV4ZWN1dGVDb21tYW5kKSB7XG4gICAgICAgIGRyaXZlclJlcyA9IGF3YWl0IGRyaXZlci5leGVjdXRlQ29tbWFuZChzcGVjLmNvbW1hbmQsIC4uLmFyZ3MpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZHJpdmVyUmVzID0gYXdhaXQgZHJpdmVyLmV4ZWN1dGUoc3BlYy5jb21tYW5kLCAuLi5hcmdzKTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IHRoZSBwcm90b2NvbCBhZnRlciBleGVjdXRlQ29tbWFuZFxuICAgICAgY3VycmVudFByb3RvY29sID0gZXh0cmFjdFByb3RvY29sKGRyaXZlciwgcmVxLnBhcmFtcy5zZXNzaW9uSWQpIHx8IGN1cnJlbnRQcm90b2NvbDtcblxuICAgICAgLy8gSWYgYGV4ZWN1dGVDb21tYW5kYCB3YXMgb3ZlcnJpZGRlbiBhbmQgdGhlIG1ldGhvZCByZXR1cm5zIGFuIG9iamVjdFxuICAgICAgLy8gd2l0aCBhIHByb3RvY29sIGFuZCB2YWx1ZS9lcnJvciBwcm9wZXJ0eSwgcmUtYXNzaWduIHRoZSBwcm90b2NvbFxuICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChkcml2ZXJSZXMpICYmIF8uaGFzKGRyaXZlclJlcywgJ3Byb3RvY29sJykpIHtcbiAgICAgICAgY3VycmVudFByb3RvY29sID0gZHJpdmVyUmVzLnByb3RvY29sIHx8IGN1cnJlbnRQcm90b2NvbDtcbiAgICAgICAgaWYgKGRyaXZlclJlcy5lcnJvcikge1xuICAgICAgICAgIHRocm93IGRyaXZlclJlcy5lcnJvcjtcbiAgICAgICAgfVxuICAgICAgICBkcml2ZXJSZXMgPSBkcml2ZXJSZXMudmFsdWU7XG4gICAgICB9XG5cbiAgICAgIC8vIHVucGFjayBjcmVhdGVTZXNzaW9uIHJlc3BvbnNlXG4gICAgICBpZiAoc3BlYy5jb21tYW5kID09PSBDUkVBVEVfU0VTU0lPTl9DT01NQU5EKSB7XG4gICAgICAgIG5ld1Nlc3Npb25JZCA9IGRyaXZlclJlc1swXTtcbiAgICAgICAgU0VTU0lPTlNfQ0FDSEUucHV0U2Vzc2lvbihuZXdTZXNzaW9uSWQsIGN1cnJlbnRQcm90b2NvbCk7XG4gICAgICAgIFNFU1NJT05TX0NBQ0hFLmdldExvZ2dlcihuZXdTZXNzaW9uSWQsIGN1cnJlbnRQcm90b2NvbClcbiAgICAgICAgICAuZGVidWcoYENhY2hlZCB0aGUgcHJvdG9jb2wgdmFsdWUgJyR7Y3VycmVudFByb3RvY29sfScgZm9yIHRoZSBuZXcgc2Vzc2lvbiAke25ld1Nlc3Npb25JZH1gKTtcbiAgICAgICAgaWYgKGN1cnJlbnRQcm90b2NvbCA9PT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuTUpTT05XUCkge1xuICAgICAgICAgIGRyaXZlclJlcyA9IGRyaXZlclJlc1sxXTtcbiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50UHJvdG9jb2wgPT09IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLlczQykge1xuICAgICAgICAgIGRyaXZlclJlcyA9IHtcbiAgICAgICAgICAgIGNhcGFiaWxpdGllczogZHJpdmVyUmVzWzFdLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIElmIHRoZSBNSlNPTldQIGVsZW1lbnQga2V5IGZvcm1hdCAoRUxFTUVOVCkgd2FzIHByb3ZpZGVkIHRyYW5zbGF0ZSBpdCB0byBXM0MgZWxlbWVudCBrZXkgZm9ybWF0IChlbGVtZW50LTYwNjYtMTFlNC1hNTJlLTRmNzM1NDY2Y2VjZilcbiAgICAgIC8vIGFuZCB2aWNlLXZlcnNhXG4gICAgICBpZiAoZHJpdmVyUmVzKSB7XG4gICAgICAgIGlmIChjdXJyZW50UHJvdG9jb2wgPT09IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLlczQykge1xuICAgICAgICAgIGRyaXZlclJlcyA9IHJlbmFtZUtleShkcml2ZXJSZXMsIE1KU09OV1BfRUxFTUVOVF9LRVksIFczQ19FTEVNRU5UX0tFWSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZHJpdmVyUmVzID0gcmVuYW1lS2V5KGRyaXZlclJlcywgVzNDX0VMRU1FTlRfS0VZLCBNSlNPTldQX0VMRU1FTlRfS0VZKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBjb252ZXJ0IHVuZGVmaW5lZCB0byBudWxsLCBidXQgbGVhdmUgYWxsIG90aGVyIHZhbHVlcyB0aGUgc2FtZVxuICAgICAgaWYgKF8uaXNVbmRlZmluZWQoZHJpdmVyUmVzKSkge1xuICAgICAgICBkcml2ZXJSZXMgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBkZWxldGUgc2hvdWxkIG5vdCByZXR1cm4gYW55dGhpbmcgZXZlbiBpZiBzdWNjZXNzZnVsXG4gICAgICBpZiAoc3BlYy5jb21tYW5kID09PSBERUxFVEVfU0VTU0lPTl9DT01NQU5EKSB7XG4gICAgICAgIFNFU1NJT05TX0NBQ0hFLmdldExvZ2dlcihyZXEucGFyYW1zLnNlc3Npb25JZCwgY3VycmVudFByb3RvY29sKVxuICAgICAgICAgIC5kZWJ1ZyhgUmVjZWl2ZWQgcmVzcG9uc2U6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShkcml2ZXJSZXMpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pfWApO1xuICAgICAgICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQsIGN1cnJlbnRQcm90b2NvbCkuZGVidWcoJ0J1dCBkZWxldGluZyBzZXNzaW9uLCBzbyBub3QgcmV0dXJuaW5nJyk7XG4gICAgICAgIGRyaXZlclJlcyA9IG51bGw7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIHRoZSBzdGF0dXMgaXMgbm90IDAsICB0aHJvdyB0aGUgYXBwcm9wcmlhdGUgZXJyb3IgZm9yIHN0YXR1cyBjb2RlLlxuICAgICAgaWYgKHV0aWwuaGFzVmFsdWUoZHJpdmVyUmVzKSkge1xuICAgICAgICBpZiAodXRpbC5oYXNWYWx1ZShkcml2ZXJSZXMuc3RhdHVzKSAmJiAhaXNOYU4oZHJpdmVyUmVzLnN0YXR1cykgJiYgcGFyc2VJbnQoZHJpdmVyUmVzLnN0YXR1cywgMTApICE9PSAwKSB7XG4gICAgICAgICAgdGhyb3cgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUoZHJpdmVyUmVzLnN0YXR1cywgZHJpdmVyUmVzLnZhbHVlKTtcbiAgICAgICAgfSBlbHNlIGlmIChfLmlzUGxhaW5PYmplY3QoZHJpdmVyUmVzLnZhbHVlKSAmJiBkcml2ZXJSZXMudmFsdWUuZXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyBlcnJvckZyb21XM0NKc29uQ29kZShkcml2ZXJSZXMudmFsdWUuZXJyb3IsIGRyaXZlclJlcy52YWx1ZS5tZXNzYWdlLCBkcml2ZXJSZXMudmFsdWUuc3RhY2t0cmFjZSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gUmVzcG9uc2Ugc3RhdHVzIHNob3VsZCBiZSB0aGUgc3RhdHVzIHNldCBieSB0aGUgZHJpdmVyIHJlc3BvbnNlLlxuICAgICAgaWYgKGN1cnJlbnRQcm90b2NvbCAhPT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDKSB7XG4gICAgICAgIGh0dHBSZXNCb2R5LnN0YXR1cyA9IChfLmlzTmlsKGRyaXZlclJlcykgfHwgXy5pc1VuZGVmaW5lZChkcml2ZXJSZXMuc3RhdHVzKSkgPyBKU09OV1BfU1VDQ0VTU19TVEFUVVNfQ09ERSA6IGRyaXZlclJlcy5zdGF0dXM7XG4gICAgICB9XG4gICAgICBodHRwUmVzQm9keS52YWx1ZSA9IGRyaXZlclJlcztcbiAgICAgIFNFU1NJT05TX0NBQ0hFLmdldExvZ2dlcihyZXEucGFyYW1zLnNlc3Npb25JZCB8fCBuZXdTZXNzaW9uSWQsIGN1cnJlbnRQcm90b2NvbCkuZGVidWcoYFJlc3BvbmRpbmcgYCArXG4gICAgICAgIGB0byBjbGllbnQgd2l0aCBkcml2ZXIuJHtzcGVjLmNvbW1hbmR9KCkgcmVzdWx0OiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZHJpdmVyUmVzKSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KX1gKTtcblxuICAgICAgaWYgKHNwZWMuY29tbWFuZCA9PT0gREVMRVRFX1NFU1NJT05fQ09NTUFORCkge1xuICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRvIGtlZXAgdGhlIGxvZ2dlciBpbnN0YW5jZSBpbiB0aGUgY2FjaGVcbiAgICAgICAgLy8gYWZ0ZXIgdGhlIHNlc3Npb24gaXMgZGVsZXRlZCwgYmVjYXVzZSBpdCBjb250YWlucyB0aGUgbG9nZ2luZyBoaXN0b3J5XG4gICAgICAgIC8vIGFuZCBjb25zdW1lcyB0aGUgbWVtb3J5XG4gICAgICAgIFNFU1NJT05TX0NBQ0hFLnJlc2V0TG9nZ2VyKHJlcS5wYXJhbXMuc2Vzc2lvbklkKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGlmIGFueXRoaW5nIGdvZXMgd3JvbmcsIGZpZ3VyZSBvdXQgd2hhdCBvdXIgcmVzcG9uc2Ugc2hvdWxkIGJlXG4gICAgICAvLyBiYXNlZCBvbiB0aGUgdHlwZSBvZiBlcnJvciB0aGF0IHdlIGVuY291bnRlcmVkXG4gICAgICBsZXQgYWN0dWFsRXJyID0gZXJyO1xuXG4gICAgICBjdXJyZW50UHJvdG9jb2wgPSBjdXJyZW50UHJvdG9jb2wgfHwgZXh0cmFjdFByb3RvY29sKGRyaXZlciwgcmVxLnBhcmFtcy5zZXNzaW9uSWQgfHwgbmV3U2Vzc2lvbklkKTtcblxuICAgICAgbGV0IGVyck1zZyA9IGVyci5zdGFja3RyYWNlIHx8IGVyci5zdGFjaztcbiAgICAgIGlmICghXy5pbmNsdWRlcyhlcnJNc2csIGVyci5tZXNzYWdlKSkge1xuICAgICAgICAvLyBpZiB0aGUgbWVzc2FnZSBoYXMgbW9yZSBpbmZvcm1hdGlvbiwgYWRkIGl0LiBidXQgb2Z0ZW4gdGhlIG1lc3NhZ2VcbiAgICAgICAgLy8gaXMgdGhlIGZpcnN0IHBhcnQgb2YgdGhlIHN0YWNrIHRyYWNlXG4gICAgICAgIGVyck1zZyA9IGAke2Vyci5tZXNzYWdlfSR7ZXJyTXNnID8gKCdcXG4nICsgZXJyTXNnKSA6ICcnfWA7XG4gICAgICB9XG4gICAgICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQgfHwgbmV3U2Vzc2lvbklkLCBjdXJyZW50UHJvdG9jb2wpLmRlYnVnKGBFbmNvdW50ZXJlZCBgICtcbiAgICAgICAgYGludGVybmFsIGVycm9yIHJ1bm5pbmcgY29tbWFuZDogJHtlcnJNc2d9YCk7XG4gICAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IpKSB7XG4gICAgICAgIGFjdHVhbEVyciA9IGVyci5nZXRBY3R1YWxFcnJvcigpO1xuICAgICAgfVxuXG4gICAgICBpZiAoY3VycmVudFByb3RvY29sID09PSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5XM0MpIHtcbiAgICAgICAgW2h0dHBTdGF0dXMsIGh0dHBSZXNCb2R5XSA9IGdldFJlc3BvbnNlRm9yVzNDRXJyb3IoYWN0dWFsRXJyKTtcbiAgICAgIH0gZWxzZSBpZiAoY3VycmVudFByb3RvY29sID09PSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5NSlNPTldQKSB7XG4gICAgICAgIFtodHRwU3RhdHVzLCBodHRwUmVzQm9keV0gPSBnZXRSZXNwb25zZUZvckpzb253cEVycm9yKGFjdHVhbEVycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBJZiBpdCdzIHVua25vd24gd2hhdCB0aGUgcHJvdG9jb2wgaXMgKGxpa2UgaWYgaXQncyBgZ2V0U3RhdHVzYCBwcmlvciB0byBgY3JlYXRlU2Vzc2lvbmApLCBtZXJnZSB0aGUgcmVzcG9uc2VzXG4gICAgICAgIC8vIHRvZ2V0aGVyIHRvIGJlIHByb3RvY29sLWFnbm9zdGljXG4gICAgICAgIGxldCBqc29ud3BSZXMgPSBnZXRSZXNwb25zZUZvckpzb253cEVycm9yKGFjdHVhbEVycik7XG4gICAgICAgIGxldCB3M2NSZXMgPSBnZXRSZXNwb25zZUZvclczQ0Vycm9yKGFjdHVhbEVycik7XG5cbiAgICAgICAgaHR0cFJlc0JvZHkgPSB7XG4gICAgICAgICAgLi4uanNvbndwUmVzWzFdLFxuICAgICAgICAgIC4uLnczY1Jlc1sxXSxcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBVc2UgdGhlIEpTT05XUCBzdGF0dXMgY29kZSAod2hpY2ggaXMgdXN1YWxseSA1MDApXG4gICAgICAgIGh0dHBTdGF0dXMgPSBqc29ud3BSZXNbMF07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gZGVjb2RlIHRoZSByZXNwb25zZSwgd2hpY2ggaXMgZWl0aGVyIGEgc3RyaW5nIG9yIGpzb25cbiAgICBpZiAoXy5pc1N0cmluZyhodHRwUmVzQm9keSkpIHtcbiAgICAgIHJlcy5zdGF0dXMoaHR0cFN0YXR1cykuc2VuZChodHRwUmVzQm9keSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChuZXdTZXNzaW9uSWQpIHtcbiAgICAgICAgaWYgKGN1cnJlbnRQcm90b2NvbCA9PT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDKSB7XG4gICAgICAgICAgaHR0cFJlc0JvZHkudmFsdWUuc2Vzc2lvbklkID0gbmV3U2Vzc2lvbklkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGh0dHBSZXNCb2R5LnNlc3Npb25JZCA9IG5ld1Nlc3Npb25JZDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaHR0cFJlc0JvZHkuc2Vzc2lvbklkID0gcmVxLnBhcmFtcy5zZXNzaW9uSWQgfHwgbnVsbDtcbiAgICAgIH1cblxuICAgICAgLy8gRG9uJ3QgaW5jbHVkZSBzZXNzaW9uSWQgaW4gVzNDIHJlc3BvbnNlc1xuICAgICAgaWYgKGN1cnJlbnRQcm90b2NvbCA9PT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDKSB7XG4gICAgICAgIGRlbGV0ZSBodHRwUmVzQm9keS5zZXNzaW9uSWQ7XG4gICAgICB9XG4gICAgICByZXMuc3RhdHVzKGh0dHBTdGF0dXMpLmpzb24oaHR0cFJlc0JvZHkpO1xuICAgIH1cbiAgfTtcbiAgLy8gYWRkIHRoZSBtZXRob2QgdG8gdGhlIGFwcFxuICBhcHBbbWV0aG9kLnRvTG93ZXJDYXNlKCldKHBhdGgsIChyZXEsIHJlcykgPT4ge1xuICAgIEIucmVzb2x2ZShhc3luY0hhbmRsZXIocmVxLCByZXMpKS5kb25lKCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBkcml2ZXJTaG91bGREb0p3cFByb3h5IChkcml2ZXIsIHJlcSwgY29tbWFuZCkge1xuICAvLyBkcml2ZXJzIG5lZWQgdG8gZXhwbGljaXRseSBzYXkgd2hlbiB0aGUgcHJveHkgaXMgYWN0aXZlXG4gIGlmICghZHJpdmVyLnByb3h5QWN0aXZlKHJlcS5wYXJhbXMuc2Vzc2lvbklkKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIHdlIHNob3VsZCBuZXZlciBwcm94eSBkZWxldGVTZXNzaW9uIGJlY2F1c2Ugd2UgbmVlZCB0byBnaXZlIHRoZSBjb250YWluaW5nXG4gIC8vIGRyaXZlciBhbiBvcHBvcnR1bml0eSB0byBjbGVhbiBpdHNlbGYgdXBcbiAgaWYgKGNvbW1hbmQgPT09ICdkZWxldGVTZXNzaW9uJykge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIHZhbGlkYXRlIGF2b2lkYW5jZSBzY2hlbWEsIGFuZCBzYXkgd2Ugc2hvdWxkbid0IHByb3h5IGlmIGFueXRoaW5nIGluIHRoZVxuICAvLyBhdm9pZCBsaXN0IG1hdGNoZXMgb3VyIHJlcVxuICBpZiAoZHJpdmVyLnByb3h5Um91dGVJc0F2b2lkZWQocmVxLnBhcmFtcy5zZXNzaW9uSWQsIHJlcS5tZXRob2QsIHJlcS5vcmlnaW5hbFVybCkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBpZiBpdCBsb29rcyBsaWtlIHdlIGhhdmUgYW4gaW1hZ2UgZWxlbWVudCBpbiB0aGUgdXJsIChhcyBhIHJvdXRlXG4gIC8vIHBhcmFtZXRlciksIG5ldmVyIHByb3h5LiBKdXN0IGxvb2sgZm9yIG91ciBpbWFnZSBlbGVtZW50IHByZWZpeCBpbiBhbGxvd2VkXG4gIC8vIHBvc2l0aW9ucyAoZWl0aGVyIGFmdGVyIGFuICdlbGVtZW50JyBvciAnc2NyZWVuc2hvdCcgcGF0aCBzZWdtZW50KSwgYW5kXG4gIC8vIGVuc3VyZSB0aGUgcHJlZml4IGlzIGZvbGxvd2VkIGJ5IHNvbWV0aGluZ1xuICBpZiAoSU1HX0VMX1VSTF9SRS50ZXN0KHJlcS5vcmlnaW5hbFVybCkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuXG4gIC8vIGFsc28gaWYgaXQgbG9va3MgbGlrZSB3ZSBoYXZlIGFuIGltYWdlIGVsZW1lbnQgaW4gdGhlIHJlcXVlc3QgYm9keSAoYXNcbiAgLy8gYSBKU09OIHBhcmFtZXRlciksIG5ldmVyIHByb3h5LiBCYXNpY2FsbHkgY2hlY2sgYWdhaW5zdCBhIHJlZ2V4cCBvZiB0aGVcbiAgLy8ganNvbiBzdHJpbmcgb2YgdGhlIGJvZHksIHdoZXJlIHdlIGtub3cgd2hhdCB0aGUgZm9ybSBvZiBhbiBpbWFnZSBlbGVtZW50XG4gIC8vIG11c3QgYmVcbiAgY29uc3Qgc3RyaW5nQm9keSA9IEpTT04uc3RyaW5naWZ5KHJlcS5ib2R5KTtcbiAgaWYgKHN0cmluZ0JvZHkgJiYgSU1HX0VMX0JPRFlfUkUudGVzdChzdHJpbmdCb2R5KSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkb0p3cFByb3h5IChkcml2ZXIsIHJlcSwgcmVzKSB7XG4gIFNFU1NJT05TX0NBQ0hFLmdldExvZ2dlcihyZXEucGFyYW1zLnNlc3Npb25JZCwgZXh0cmFjdFByb3RvY29sKGRyaXZlciwgcmVxLnBhcmFtcy5zZXNzaW9uSWQpKVxuICAgIC5pbmZvKCdEcml2ZXIgcHJveHkgYWN0aXZlLCBwYXNzaW5nIHJlcXVlc3Qgb24gdmlhIEhUVFAgcHJveHknKTtcblxuICAvLyBjaGVjayB0aGF0IHRoZSBpbm5lciBkcml2ZXIgaGFzIGEgcHJveHkgZnVuY3Rpb25cbiAgaWYgKCFkcml2ZXIuY2FuUHJveHkocmVxLnBhcmFtcy5zZXNzaW9uSWQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gcHJveHkgdG8gYSBKU09OV1Agc2VydmVyIGJ1dCBkcml2ZXIgaXMgdW5hYmxlIHRvIHByb3h5Jyk7XG4gIH1cbiAgdHJ5IHtcbiAgICBjb25zdCBwcm94aWVkUmVzID0gYXdhaXQgZHJpdmVyLmV4ZWN1dGVDb21tYW5kKCdwcm94eVJlcVJlcycsIHJlcSwgcmVzLCByZXEucGFyYW1zLnNlc3Npb25JZCk7XG4gICAgaWYgKHByb3hpZWRSZXMgJiYgcHJveGllZFJlcy5lcnJvcikgdGhyb3cgcHJveGllZFJlcy5lcnJvcjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IpKSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHByb3h5LiBQcm94eSBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cbn1cblxuXG5leHBvcnQge1xuICBQcm90b2NvbCwgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uLCBpc1Nlc3Npb25Db21tYW5kLFxuICBNSlNPTldQX0VMRU1FTlRfS0VZLCBXM0NfRUxFTUVOVF9LRVksIElNQUdFX0VMRU1FTlRfUFJFRklYLFxuICBkcml2ZXJTaG91bGREb0p3cFByb3h5LFxufTtcbiJdLCJmaWxlIjoibGliL3Byb3RvY29sL3Byb3RvY29sLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
